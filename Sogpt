Dim full_esg_path As String
full_esg_path = param_ws.Range("esg_file").Value

' Open the ESG file as early as possible, but process only whatâ€™s needed
Set esg_wkb = Workbooks.Open(Filename:=full_esg_path, ReadOnly:=True)

Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

With esg_wkb.Sheets("raw_data")
    .AutoFilterMode = False
    .Rows(1).AutoFilter Field:=1, Criteria1:=ptf_code      ' PTF_CODE
    .Rows(1).AutoFilter Field:=2, Criteria1:=univers_name  ' Nom ptf
    .UsedRange.SpecialCells(xlCellTypeVisible).Copy
End With

' Create and prepare filtered temporary file
Set temp_wkb = Workbooks.Add
With temp_wkb.Sheets(1)
    .Name = "raw_data"
    .Range("A1").PasteSpecial xlPasteValues
End With

Application.CutCopyMode = False

' Save filtered version
temp_path = Environ("TEMP") & "\filtered_esg_data.xlsx"
temp_wkb.SaveAs temp_path, FileFormat:=xlOpenXMLWorkbook
temp_wkb.Close SaveChanges:=False

esg_wkb.Close SaveChanges:=False

' Assign filtered version path to variable
esg_file = temp_path

Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
